# Crumar BIT 99 Hardware Implementation

## Architecture Overview

The BIT 99 uses an Intel 8031 microcontroller (external ROM) as the main processor, interfacing with:

* 4K external SRAM (0x0000-0x0FFF)
* 8K external EPROM (contains lookup tables and some code at 0x2000+)
* Multiple hardware interface registers
* 4×8253 timer chips for DCO frequency generation
* Sample & Hold circuits for analog control voltage generation
* MIDI UART for external communication

**Key Architecture Point:** All control voltages (per-voice and global) are generated by a single 8-bit DAC using time-multiplexed Sample & Hold circuits. The CPU performs burst writes: **select channel (0x1003) → write data (0x1005) → disable S&H (0x1003 = 3Fh)**.

## Intel 8031 Microcontroller Hardware Interface

### Pinout and Connections

```
                Intel 8031 (40-pin DIP)
                     ┌─────────────┐
P1.0 (Switch Row 0) ─┤1          40├─ VCC (+5V)
P1.1 (Switch Row 1) ─┤2          39├─ P0.0 (AD0) ─── Address/Data Bus
P1.2 (Switch Row 2) ─┤3          38├─ P0.1 (AD1) ─── Address/Data Bus
P1.3 (Switch Row 3) ─┤4          37├─ P0.2 (AD2) ─── Address/Data Bus
P1.4 (Switch Row 4) ─┤5          36├─ P0.3 (AD3) ─── Address/Data Bus
P1.5 (Switch Row 5) ─┤6          35├─ P0.4 (AD4) ─── Address/Data Bus
P1.6 (Switch Row 6) ─┤7          34├─ P0.5 (AD5) ─── Address/Data Bus
P1.7 (Switch Row 7) ─┤8          33├─ P0.6 (AD6) ─── Address/Data Bus
        RST (Reset) ─┤9          32├─ P0.7 (AD7) ─── Address/Data Bus
  P3.0 (RXD/Keybed) ─┤10         31├─ EA (tied to GND)
  P3.1 (TXD/Keybed) ─┤11         30├─ ALE (Address Latch Enable)
        P3.2 (INT0) ─┤12         29├─ PSEN (Program Store Enable)
        P3.3 (INT1) ─┤13         28├─ P2.7 (A15) ──── High Address Bus
          P3.4 (T0) ─┤14         27├─ P2.6 (A14) ──── High Address Bus
          P3.5 (T1) ─┤15         26├─ P2.5 (A13) ──── High Address Bus
          P3.6 (WR) ─┤16         25├─ P2.4 (A12) ──── High Address Bus
          P3.7 (RD) ─┤17         24├─ P2.3 (A11) ──── High Address Bus
              XTAL2 ─┤18         23├─ P2.2 (A10) ──── High Address Bus
              XTAL1 ─┤19         22├─ P2.1 (A9) ───── High Address Bus
                GND ─┤20         21├─ P2.0 (A8) ───── High Address Bus
                     └─────────────┘
```

### Port Pin Functions

**Port 1 (P1.0-P1.7) - Switch Matrix Inputs**

```
P1.0 (Pin 1)  - Switch matrix row 0 input
P1.1 (Pin 2)  - Switch matrix row 1 input  
P1.2 (Pin 3)  - Switch matrix row 2 input
P1.3 (Pin 4)  - Switch matrix row 3 input
P1.4 (Pin 5)  - Switch matrix row 4 input
P1.5 (Pin 6)  - Switch matrix row 5 input (also release pedal input)
P1.6 (Pin 7)  - Switch matrix row 6 input
P1.7 (Pin 8)  - Switch matrix row 7 input
```

**Port 3 (P3.0-P3.7) - Special Functions**

```
P3.0 (Pin 10) - RXD: Serial receive from keybed microcontroller
P3.1 (Pin 11) - TXD: Serial transmit to keybed microcontroller / tape handshake
P3.2 (Pin 12) - INT0: External interrupt 0 (MIDI TX interrupt)
P3.3 (Pin 13) - INT1: External interrupt 1 (MIDI RX interrupt)
P3.4 (Pin 14) - T0: ADC mux select (0=pitch bend, 1=mod wheel)
P3.5 (Pin 15) - T1: MIDI UART chip select (1=enable, 0=disable)
P3.6 (Pin 16) - WR: External memory write strobe
P3.7 (Pin 17) - RD: External memory read strobe
```

**Port 0 (P0.0-P0.7) - Multiplexed Address/Data Bus**

```
P0.0-P0.7 (Pins 32-39) - Multiplexed low address (A0-A7) and data bus (D0-D7)
                        - Used for external SRAM and I/O register access
```

**Port 2 (P2.0-P2.7) - High Address Bus**

```
P2.0-P2.7 (Pins 21-28) - High address bus (A8-A15)
                        - Used for external memory addressing
```

**Control and Power Pins**

```
RST (Pin 9)    - Reset input (active high)
EA (Pin 31)    - External Access (tied to GND for external ROM)
ALE (Pin 30)   - Address Latch Enable (latches low address from P0)
PSEN (Pin 29)  - Program Store Enable (enables external ROM)
XTAL1 (Pin 19) - Crystal oscillator input
XTAL2 (Pin 18) - Crystal oscillator output
VCC (Pin 40)   - +5V power supply
GND (Pin 20)   - Ground
```

## Memory Architecture

### Memory Map Overview

* **CPU:** Intel 8031 @ 12 MHz (external ROM configuration)
* **Program ROM:** 8K EPROM (IC26), mapped at `$0000-$1FFF`

* **Lookup Tables ROM:** 8K EPROM (IC27), mapped at `$2000-$3FFF`
* **Work RAM:** 4K SRAM mapped at `$0000-$0FFF` (battery-backed patch storage)
* **I/O Block:** `$1000-$101F` decoded for hardware interface registers

### Internal RAM (8031 on-chip, 0x00-0xFF)

| Addr Range  | Purpose                                                    |
|-------------|-----------------------------------------------------------|
| `0x00-0x07` | Register bank 0 (R0-R7)                                  |
| `0x08-0x0F` | Register bank 1 (alternate R0-R7)                        |
| `0x08-0x13` | Voice note assignments (VCE1NOTE-VCE6VAR)                |
| `0x20-0x2F` | Bit-addressable area and system flags                    |
| `0x26` | LFO Flags Byte 1 (LFO1/LFO2 routing destinations)       |
| `0x27` | LFO Flags Byte 2 (LFO waveforms and invert)             |
| `0x28` | System flags (split/double mode, MIDI enables)           |
| `0x2A-0x2B` | Waveform select shadow registers                          |
| `0x30-0x31` | Current LFO1/LFO2 values                                 |
| `0x80-0xFF` | Additional variables and stack space                     |

### External SRAM Layout (0x0000-0x0FFF, battery-backed)

| Addr Range      | Purpose                                                   |
|-----------------|----------------------------------------------------------|
| `0x0000-0x002F` | Voice parameter arrays (8 bytes × 6 voices)             |
| `0x0030-0x0035` | DAC values for filter cutoff (VC1-VC6)                  |
| `0x0036-0x003B` | DAC values for VCA control (VEN1-VEN6, inverted)        |
| `0x003E` | LED mode display shadow register                         |
| `0x0067-0x006E` | 8-digit LED display buffer                               |
| `0x006F-0x0096` | Lower program parameter cache                            |
| `0x0097-0x00BE` | Upper program parameter cache                            |
| `0x0093-0x0094` | VPU1-VPU2 DAC values (DCO pulse width 1-2)             |
| `0x00BB-0x00BC` | VPU3-VPU4 DAC values (DCO pulse width 3-4)             |
| `0x00BD-0x00C6` | Envelope timing parameters                               |
| `0x00CD-0x00CE` | MIDI modulation and channel configuration                |
| `0x00CF-0x00DA` | Split point, transpose, and key data                    |
| `0x00DD-0x00EF` | Switch event circular buffer                             |
| `0x00F7-0x00FF` | Serial buffer management pointers                       |
| `0x0100-0x01FF` | MIDI RX circular buffer (256 bytes)                     |
| `0x0200-0x02FF` | Keybed RX circular buffer (256 bytes)                   |
| `0x0300-0x037F` | Tape TX buffer (128 bytes, FSK encoding)                |
| `0x0380-0x0E56` | Single programs 1-75 (37 bytes each = 2775 bytes)       |
| `0x0E57-0x0EFE` | Split/Double programs 76-99 (7 bytes each = 168 bytes)  |
| `0x0EFF-0x0F23` | Lower program working buffer (37 bytes)                 |
| `0x0F24-0x0F48` | Upper program working buffer (37 bytes)                 |
| `0x0FF0-0x0FFF` | System configuration and flags                           |

### External ROM/EPROM Lookup Tables

| Range         | Size    | Description                                    | Usage                |
|---------------|---------|------------------------------------------------|----------------------|
| `0x2000-0x20FF` | 256 B | Rising envelope/Triangle LFO table           | Envelope attack, LFO |
| `0x2100-0x21FF` | 256 B | Falling envelope/Sawtooth LFO table          | Envelope decay/release, LFO |
| `0x2200-0x22FF` | 256 B | Secondary modulation curve table             | Special modulation shapes |
| `0x2300-0x237F` | 128 B | Primary timer values (64 × 16-bit words)    | Envelope timing      |
| `0x2380-0x23FF` | 128 B | Secondary timer values (64 × 16-bit words)  | Extended timing      |
| `0x2400-0x24F3` | 244 B | MIDI note to timer divider (122 × 16-bit)   | DCO frequency generation |
| `0x2500-0x25FF` | 256 B | DCO pulse width DAC values                   | Pulse width modulation |
| `0x3000+` | var   | Timer interrupt service routine              | Real-time CV updates |

**Frequency Lookup Table Details (0x2400-0x24F3):**
This table contains 122 16-bit timer divider values for equal temperament tuning:

* Each entry corresponds to a MIDI note number
* Values calculated for 2MHz input clock with /16 scaling
* Provides precise musical frequencies across full MIDI range

## I/O Register Map (0x1000-0x101F)

| Address     | Direction | Function                                          |
|-------------|-----------|---------------------------------------------------|
| `0x1000` | R/W       | NEC µPD71051 USART data register (P3.5 = chip select) |
| `0x1001` | W         | Waveform selects 1 & 3 (lower 6 bits inverted)    |
| `0x1002` | W         | Waveform selects 2 & 4 + switch column 3 control  |
| `0x1003` | W         | S&H channel select + switch columns 1 & 2 control |
| `0x1004` | W         | Mode LEDs + tape control (shadow register 0x3E)   |
| `0x1005` | W         | DAC0800 output register (8-bit DAC)               |
| `0x1006` | W         | 7-segment display output                          |
| `0x1007` | R         | ADC input (P3.4 selects mod wheel vs pitch bend)  |
| `0x1010` | R/W       | IC35 Counter 0 (Voice 1 DCO1)                     |
| `0x1011` | R/W       | IC35 Counter 1 (Voice 1 DCO2)                     |
| `0x1012` | R/W       | IC35 Counter 2 (Voice 2 DCO1)                     |
| `0x1013` | W         | IC35 Control Word Register                        |
| `0x1014` | R/W       | IC36 Counter 0 (Voice 2 DCO2)                     |
| `0x1015` | R/W       | IC36 Counter 1 (Voice 3 DCO1)                     |
| `0x1016` | R/W       | IC36 Counter 2 (Voice 3 DCO2)                     |
| `0x1017` | W         | IC36 Control Word Register                        |
| `0x1018` | R/W       | IC37 Counter 0 (Voice 4 DCO1)                     |
| `0x1019` | R/W       | IC37 Counter 1 (Voice 4 DCO2)                     |
| `0x101A` | R/W       | IC37 Counter 2 (Voice 5 DCO1)                     |
| `0x101B` | W         | IC37 Control Word Register                        |
| `0x101C` | R/W       | IC38 Counter 0 (Voice 5 DCO2)                     |
| `0x101D` | R/W       | IC38 Counter 1 (Voice 6 DCO1)                     |
| `0x101E` | R/W       | IC38 Counter 2 (Voice 6 DCO2)                     |
| `0x101F` | W         | IC38 Control Word Register                        |

**Direction Key:** R = Read Only, W = Write Only, R/W = Read/Write

### Detailed Register Specifications

**0x1000 - NEC µPD71051 USART Data Register**

* NEC µPD71051 Serial Control Unit (CMOS USART)
* P3.5 = 1: Enable USART chip select
* P3.5 = 0: Disable USART chip select
* Interrupt-driven RX/TX with circular buffers

**0x1001 - Waveform Selects 1 & 3 Register (IC23)**

* Controls waveform selection for DCO voices 1 and 3
* Source: Shadow register 0x2A with bit manipulation before output
* Write sequence (code at 0x07F8-0x0807):
  1. Load shadow 0x2A into accumulator and breg
  2. Complement accumulator (invert all bits)
  3. AND accumulator with 0x3F (keep only bits 5-0 inverted)
  4. AND breg with 0xC0 (keep only bits 7-6 original)
  5. OR results together
  6. Write to 0x1001
* Bits 7-6: Passed through unchanged from shadow (possible additional control signals)
* Bits 5-0: Inverted from shadow register (active-low waveform enables)
* Each voice (1 and 3) uses 3 bits for triangle/sawtooth/pulse waveform selection

**0x1002 - Waveform Selects 2 & 4 Register + Switch Column 3 (IC22)**

* Controls waveform selection for DCO voices 2 and 4, plus switch matrix scanning
* Source: Shadow register 0x2B with special handling
* Write sequence (code at 0x1A45-0x1A54):
  1. Write S&H select value to 0x1003
  2. Load shadow 0x2B into accumulator
  3. Save bit 6 to carry flag
  4. Complement all bits in accumulator
  5. Restore bit 6 from carry flag (preserving original value)
  6. Write to 0x1002
* Bits 7, 5-0: Inverted from shadow 0x2B (active-low waveform enables for voices 2 and 4)
* Bit 6: NOT inverted - controls switch column 3 drive (0 = inactive, 1 = active scan)
* This register multiplexes waveform control and switch scanning on same hardware IC

**0x1003 - S&H Channel Select + Switch Columns 1 & 2 (IC17)**

This register controls three 4051 8-channel analog multiplexer chips that route DAC output to 24 Sample & Hold circuits.

**Bit Assignment:**

* Bits 0-2: Channel select lines (A, B, C) - connected to all three 4051 chips
  * These 3 bits select which of 8 channels (0-7) on the enabled chip(s)
* Bit 3: Chip select for first 4051 (IC20) - 1 = enable chip
* Bit 4: Chip select for second 4051 (IC21) - 1 = enable chip  
* Bit 5: Chip select for third 4051 (IC22) - 1 = enable chip
* Bit 6: Switch matrix column 1 drive (1 = activate column for scanning)
* Bit 7: Switch matrix column 2 drive (1 = activate column for scanning)

**4051 Multiplexer Operation:**

* Each 4051 routes 1 of 8 analog inputs to its output based on bits 0-2
* Bits 3-5 enable which 4051 chip(s) pass signal to their S&H circuits
* Multiple chips can be enabled simultaneously (bits 3-5 not mutually exclusive)
* Code 0x3F (0b00111111) enables all three chips on channel 7 - used as "disable/hold all"

**Typical CV update sequence:**

1. Write channel code (bits 5-3 select chip, bits 2-0 select channel within chip)
2. Write value to DAC at 0x1005
3. Write 0x3F to hold all channels (or next channel code to continue updates)

**0x1004 - Mode LEDs + Tape Control (IC3)**

* Bits 0-5: Mode LED outputs (inverted from shadow 0x3E: shadow 1 = LED on, output 0 = LED on)
  * Bit 0: ADDRESS LED
  * Bit 1: COMPARE LED
  * Bit 2: LOWER LED
  * Bit 3: PARK LED
  * Bit 4: UPPER LED
  * Bit 5: Additional mode LED
* Bit 6: Tape output enable (1 = enable FSK output to cassette)
* Bit 7: Appears unused in analyzed code
* Shadow register at 0x3E: firmware sets bit=1 for LED on, hardware inverts before output
* Write sequence: firmware writes to 0x3E shadow → calls L0861 → reads shadow, complements, writes to 0x1004

**0x1005 - DAC Output**

* 8-bit DAC for selected analog channel
* Used with S&H select to update control voltages

**0x1006 - Display Register**

* 7-segment display digit output
* Multiplexed display system

**0x1007 - ADC Input**

* P3.4 = 0: Pitch bend wheel
* P3.4 = 1: Modulation wheel
* Alternated each timer interrupt cycle

### Sample & Hold Channel Codes (Register 0x1003)

The BIT 99 uses three 4051 8-channel analog multiplexers feeding Sample & Hold circuits. Bits 0-2 select the channel (0-7) within a chip, while bits 3-5 enable which 4051 chip routes to its S&H circuits.

**Channel Code Format:** `0b00[bit5][bit4][bit3][bit2][bit1][bit0]`

* Bits 2-0: Channel address (0-7) on 4051 A/B/C select lines
* Bit 3: Enable IC20 (first 4051 chip)
* Bit 4: Enable IC21 (second 4051 chip)
* Bit 5: Enable IC22 (third 4051 chip)

| Code | Hex  | Binary   | Chip Enable | Channel | Function                           | Signal Name |
|------|------|----------|-------------|---------|------------------------------------|-------------|
| 48   | 0x30 | 00110000 | IC21+IC22   | 0       | Voice 1 filter cutoff              | VC1         |
| 49   | 0x31 | 00110001 | IC21+IC22   | 1       | Voice 2 filter cutoff              | VC2         |
| 50   | 0x32 | 00110010 | IC21+IC22   | 2       | Voice 3 filter cutoff              | VC3         |
| 51   | 0x33 | 00110011 | IC21+IC22   | 3       | Voice 4 filter cutoff              | VC4         |
| 52   | 0x34 | 00110100 | IC21+IC22   | 4       | Voice 5 filter cutoff              | VC5         |
| 53   | 0x35 | 00110101 | IC21+IC22   | 5       | Voice 6 filter cutoff              | VC6         |
| 54   | 0x36 | 00110110 | IC21+IC22   | 6       | Voice 1 VCA envelope (inverted)    | VEN1        |
| 55   | 0x37 | 00110111 | IC21+IC22   | 7       | Voice 2 VCA envelope (inverted)    | VEN2        |
| 40   | 0x28 | 00101000 | IC21        | 0       | Voice 3 VCA envelope (inverted)    | VEN3        |
| 41   | 0x29 | 00101001 | IC21        | 1       | Voice 4 VCA envelope (inverted)    | VEN4        |
| 42   | 0x2A | 00101010 | IC21        | 2       | Voice 5 VCA envelope (inverted)    | VEN5        |
| 43   | 0x2B | 00101011 | IC21        | 3       | Voice 6 VCA envelope (inverted)    | VEN6        |
| 44   | 0x2C | 00101100 | IC21        | 4       | DCO pulse width 1                  | VPU1        |
| 45   | 0x2D | 00101101 | IC21        | 5       | DCO pulse width 2                  | VPU2        |
| 46   | 0x2E | 00101110 | IC21        | 6       | DCO pulse width 3                  | VPU3        |
| 47   | 0x2F | 00101111 | IC21        | 7       | DCO pulse width 4                  | VPU4        |
| 24   | 0x18 | 00011000 | IC20        | 0       | LFO1 modulation output             | VLFO1       |
| 25   | 0x19 | 00011001 | IC20        | 1       | LFO2 modulation output             | VLFO2       |
| 26   | 0x1A | 00011010 | IC20        | 2       | Filter resonance voices 1-3        | VRE1        |
| 27   | 0x1B | 00011011 | IC20        | 3       | Filter resonance voices 4-6        | VRE2        |
| 28   | 0x1C | 00011100 | IC20        | 4       | DCO detune control                 | VDETUNE     |
| 29   | 0x1D | 00011101 | IC20        | 5       | Pitch bend control                 | VBEND       |
| 30   | 0x1E | 00011110 | IC20        | 6       | Noise generator 1                  | VNOISE1     |
| 31   | 0x1F | 00011111 | IC20        | 7       | Noise generator 2                  | VNOISE2     |
| 63   | 0x3F | 00111111 | All 3 chips | 7       | Disable all S&H (hold all values)  | -           |
| 29   | 0x1D | Pitch bend control                 | IC20     | VBEND       |
| 30   | 0x1E | Noise generator 1                  | IC20     | VNOISE1     |
| 31   | 0x1F | Noise generator 2                  | IC20     | VNOISE2     |
| 63   | 0x3F | Disable all S&H (hold all values)  | All      | -           |

**Note**: VCA envelope values (VEN1-VEN6) are complemented (inverted) by firmware before writing to DAC, as VCA control is active-low.

## Control Voltage Generation System

The BIT 99 uses a sophisticated time-multiplexed system where a single 8-bit DAC generates all 24 control voltages:

### Hardware Architecture

**DAC and Multiplexing:**

* Single DAC0800 8-bit DAC (register 0x1005) shared by all 24 control voltages
* Three 4051 8-channel analog multiplexers (IC20, IC21, IC22) route DAC output
* 24 Sample & Hold circuits capture and hold individual CV values
* Control via register 0x1003: bits 0-2 select channel, bits 3-5 enable chip(s)

**Update Rate:**

* All 24 channels refreshed every Timer 0 interrupt: **325.5 Hz** (3.072ms period)
* No variation between channels - all maintain identical refresh rate
* Sequential burst write pattern: select channel → write DAC → disable (hold)

### Hardware Write Timing (Machine Cycles)

Each S&H channel update requires a specific sequence of I/O register writes. Timing varies by complexity:

**Hardware Write Sequence (example for VC1):**

```
mov dptr,#01005H    ; 2 cycles - load DAC register address
movx a,@r0          ; 2 cycles - read CV value from RAM
movx @dptr,a        ; 2 cycles - write to DAC output
mov dptr,#01003H    ; 2 cycles - load S&H control register address
mov a,#030H         ; 1 cycle  - load channel code (VC1)
movx @dptr,a        ; 2 cycles - enable S&H channel (capture DAC value)
inc r0              ; 1 cycle  - advance RAM pointer
mov a,#03FH         ; 1 cycle  - load disable-all code
movx @dptr,a        ; 2 cycles - disable all S&H (hold captured values)
```

**Hardware Write Time by Channel Type:**

* **Simple channels** (18 channels): **15 machine cycles = 15 microseconds**
  * VC1-VC6 (filter cutoff), VRE1-VRE2 (resonance), VPU1-VPU4 (pulse width)
  * VBEND (pitch bend), VNOISE1-VNOISE2 (noise)
  * 9 instructions: load addresses, read RAM, write DAC, enable/disable S&H
  
* **Inverted channels** (6 channels): **16 machine cycles = 16 microseconds**
  * VEN1-VEN6 (VCA envelopes - active low, requires inversion)
  * VDETUNE (detune CV - inverted)
  * 10 instructions: adds `cpl a` to complement value before DAC write
  
* **Computed channels** (2 channels): **~150-200 machine cycles = 150-200 microseconds**
  * VLFO1, VLFO2 (computed inline during hardware update)
  * Includes multiplication, conditional logic, parameter reads
  * Much longer due to real-time computation before hardware write

**Total Hardware Write Time:**

* 18 simple × 15μs = 270μs
* 6 inverted × 16μs = 96μs
* 2 computed × 175μs = 350μs (average)
* **Total: ~716 microseconds per interrupt cycle**

**Important:** For 22 of 24 channels, this timing represents only the hardware I/O operation. CV value computation happens elsewhere in firmware (envelope generators, MIDI handlers, etc.). Only LFO channels compute values during the hardware update sequence.

See software_implementation.md for complete interrupt handler task breakdown and CV computation algorithms.

### Timing Critical Operations

The CV generation follows this pattern for each channel:

1. Select S&H channel via register 0x1003 (bits 0-2 = channel, bits 3-5 = chip enable)
2. Write CV value to DAC via register 0x1005 (analog output appears immediately)
3. S&H circuit captures DAC voltage while channel enabled (~1-2μs settling time)
4. Disable S&H channels (write 0x3F to 0x1003) - capacitor holds captured voltage
5. Move to next channel (DAC output changes, but previous S&H holds its value)

**Hardware Settling Time:**

* DAC0800 settling: <1 microsecond (typ. 500ns for 8-bit DAC)
* 4051 switching: ~200ns propagation delay
* S&H acquisition: ~1-2μs (capacitor charging time)
* Total analog settling per channel: <3μs (well within 15μs write cycle)

## Interrupt Hardware

## Interrupt Hardware

### Interrupt Vector Table

| Vector   | Source     | Function                           |
|----------|------------|------------------------------------|
| `0x0000` | Reset      | System initialization              |
| `0x0003` | INT0       | MIDI TX ready interrupt            |
| `0x000B` | Timer 0    | CV updates, display refresh        |
| `0x0013` | INT1       | MIDI RX interrupt                  |
| `0x0023` | Serial     | Keybed serial communication       |

## Hardware Interface Subsystems

### Switch Matrix Interface

* Port 1 inputs connect to switch matrix rows
* Switch columns driven via I/O registers 0x1002 (bit 6) and 0x1003 (bits 6, 7)
* Release pedal connected to P1.5, polled during switch scanning

### MIDI Interface

* NEC µPD71051 USART (Serial Control Unit) connected to I/O register 0x1000
* P3.5 provides chip select signal to USART
* USART generates interrupts on P3.2 (TX ready) and P3.3 (RX ready)
* MIDI IN/OUT isolation and buffering handled by external circuitry

### Keybed Communication Hardware

**Hardware Configuration:**

* P3.0 (RXD): Serial data input from keybed microcontroller
* P3.1 (TXD): Serial data output to keybed microcontroller  
* Internal UART configured for 8-bit data, no parity
* Interrupt-driven reception via vector at 0x0023 (RI + TI)
* 256-byte circular receive buffer at 0x0200-0x02FF

**Protocol Timing:**
Two-byte sequence for each key event:

1. Note Number: Piano key - 12 (range 0x00-0x7F)
2. Velocity: 0x00 = key up, 0x01-0x1F = key down velocity

### Tape Interface Hardware

**Hardware Connections:**

* P3.1 (TXD): Dual function - keybed communication and tape handshake signal
* I/O Register 0x1004 bit 6: Tape output enable/disable control
* Tape TX buffer: 128 bytes at 0x0300-0x037F for outgoing data
* Audio output: Digital data converted to audio tones for cassette recording

**Data Format:**

* Uses frequency-shift keying (FSK) encoding for reliability
* Two audio tones represent binary 0 and 1 (typically ~1200Hz and 2400Hz)
* Includes program number, patch data, and checksum
* Can store/recall individual patches or complete program banks
* Compatible with standard audio cassette recorders

### Analog Interface

* P3.4 switches ADC input between mod wheel and pitch bend
* ADC result read from I/O register 0x1007
* Alternated each timer interrupt for continuous monitoring

### Timer Chips Interface

The BIT 99 uses four Intel 8253 programmable interval timer chips to generate precise frequencies for the 12 DCOs (Digital Controlled Oscillators):

**Chip Configuration:**

* **IC35 (TIMER1)**: Base address 0x1010-0x1013
* **IC36 (TIMER2)**: Base address 0x1014-0x1017  
* **IC37 (TIMER3)**: Base address 0x1018-0x101B
* **IC38 (TIMER4)**: Base address 0x101C-0x101F

Each 8253 provides 3 independent 16-bit counters, giving 12 total timers (2 DCOs per voice × 6 voices).

**Address Mapping within each chip:**

* Base+0: Counter 0
* Base+1: Counter 1  
* Base+2: Counter 2
* Base+3: Control Word Register

**Initialization Sequence:**
During system startup, all 12 counters are configured identically:

1. Starting at address 0x1013 (first chip's control register)
2. Three control words written per chip:
   * **0x36** for Counter 0: Mode 3, LSB/MSB loading, Binary counting
   * **0x76** for Counter 1: Mode 3, LSB/MSB loading, Binary counting  
   * **0xB6** for Counter 2: Mode 3, LSB/MSB loading, Binary counting
3. Address advances by 4 to reach next chip's control register

**Mode 3 Operation (Square Wave Rate Generator):**

* Produces square wave output with 50% duty cycle
* Output frequency = Input Clock Frequency / Loaded Count Value
* Input clock: 2MHz
* Final DCO frequency = 2MHz / divider_value / 16

**Voice-to-Timer Assignment:**

* Voice 1: Timers on IC35 (counters 0, 1)
* Voice 2: Timers on IC35 (counter 2) + IC36 (counter 0)
* Voice 3: Timers on IC36 (counters 1, 2)
* Voice 4: Timers on IC37 (counters 0, 1)
* Voice 5: Timers on IC37 (counter 2) + IC38 (counter 0)
* Voice 6: Timers on IC38 (counters 1, 2)

Each voice uses two timers for its two DCOs, allowing detuning and complex timbres.

### DCO Frequency Generation System

The BIT 99's frequency generation system converts MIDI note numbers to precise musical frequencies using the 8253 timer chips:

**Frequency Calculation Process:**

1. **MIDI Note Input**: System receives MIDI note numbers (12-120, representing C0 to C10)
2. **Octave Normalization**: Notes below 24 are raised by 12 (one octave) to ensure minimum C1
3. **Table Lookup**: 16-bit divider values retrieved from lookup table at 0x2400-0x24F3
4. **Timer Loading**: Divider values loaded into appropriate 8253 counters

**Mathematical Relationship:**

```
Timer Output Frequency = 2MHz / Loaded Divider Value
DCO Frequency = Timer Output Frequency / 16
Final Audio Frequency = 2MHz / Divider / 16
```

**Example Calculations:**

* MIDI Note 60 (Middle C, ~261.63Hz): Divider ≈ 478, Timer freq ≈ 4186Hz, DCO freq ≈ 261.6Hz
* MIDI Note 48 (C3, ~130.81Hz): Divider ≈ 956, Timer freq ≈ 2093Hz, DCO freq ≈ 130.8Hz

**Real-Time Frequency Control:**

* **Split Mode**: Different frequencies for upper/lower keyboard sections
* **Double Mode**: Layered sounds with independent tuning
* **Transpose**: Mathematical adjustment to base divider values
* **Pitch Bend**: Real-time frequency modulation via MIDI
* **Detuning**: Slight offsets between DCOs for rich textures
* **LFO Modulation**: Low-frequency oscillator affects effective frequencies

**Timer Value Loading Protocol:**
The subroutine at L1974 handles frequency updates:

1. Calculate timer address based on voice number and DCO selection
2. Retrieve 16-bit divider from frequency table
3. Write low byte first, then high byte to selected counter
4. Counter immediately begins generating new frequency

## System Timing and Performance

### Crystal Oscillator

* System uses 12MHz crystal
* Machine cycle = 12MHz/12 = 1MHz (1 microsecond per cycle)
* Timer 0 configured in Mode 0 (13-bit timer) for regular interrupts
* Timer 0 reload value: TH0=0xA0, TL0=0x00 (13-bit value: 0x1400 = 5120)
* Counts from 5120 to 8192 (overflow) = 3072 machine cycles = 3.072ms
* Timer 0 interrupt rate: 1/0.003072 ≈ 325.5 Hz (display refresh and CV updates)

### Real-time Operations

* Timer 0 interrupt fires every 3.072ms (~325.5 Hz)
* Display multiplexing updated each interrupt (8 digits × 325.5Hz = ~2.6kHz refresh per digit)
* All control voltages (24 S&H channels) updated each interrupt cycle
* Switch matrix scanned every 8th interrupt (8 × 3.072ms ≈ 24.6ms)
* ADC alternates between mod wheel and pitch bend each interrupt

### Real-Time Performance Specifications

* **Timer 0 interrupt**: 325.5Hz (3.072ms period) for CV updates and display refresh
* **Switch scanning**: Every 8th interrupt (~24.6ms cycle time)
* **ADC sampling**: Alternates between mod wheel and pitch bend each interrupt (162.75Hz per channel)
* **MIDI processing**: Interrupt-driven with 256-byte circular buffers
* **Voice latency**: Typically <10ms from key press to sound output (depends on interrupt timing)
* **Interrupt latency**: <50 microseconds (estimated, interrupt-driven architecture)
* **Key-to-sound delay**: <10 milliseconds total system latency
* **Maximum key rate**: Limited by MIDI (31.25 kbaud) not keybed interface

### Display and User Interface Hardware

* 8-digit multiplexed LED display
* Switch matrix scanning (3 columns × 8 rows)
* Mode LEDs (Address, Compare, Lower, Upper, Split, Double, Park, Tape)
* Parameter editing with increment/decrement switches
* Front panel tape button for cassette patch storage operations
