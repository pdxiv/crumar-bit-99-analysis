# Crumar BIT 99 Hardware Implementation

## Architecture Overview

The BIT 99 uses an Intel 8031 microcontroller (external ROM) as the main processor, interfacing with:
* 4K external SRAM (0x0000-0x0FFF)
* 8K external EPROM (contains lookup tables and some code at 0x2000+)
* Multiple hardware interface registers
* 4×8253 timer chips for DCO frequency generation
* Sample & Hold circuits for analog control voltage generation
* MIDI UART for external communication

**Key Architecture Point:** All control voltages (per-voice and global) are generated by a single 8-bit DAC using time-multiplexed Sample & Hold circuits. The CPU performs burst writes: **select channel (0x1003) → write data (0x1005) → disable S&H (0x1003 = 3Fh)**.

## Intel 8031 Microcontroller Hardware Interface

### Pinout and Connections

```
                Intel 8031 (40-pin DIP)
                     ┌─────────────┐
P1.0 (Switch Row 0) ─┤1          40├─ VCC (+5V)
P1.1 (Switch Row 1) ─┤2          39├─ P0.0 (AD0) ─── Address/Data Bus
P1.2 (Switch Row 2) ─┤3          38├─ P0.1 (AD1) ─── Address/Data Bus
P1.3 (Switch Row 3) ─┤4          37├─ P0.2 (AD2) ─── Address/Data Bus
P1.4 (Switch Row 4) ─┤5          36├─ P0.3 (AD3) ─── Address/Data Bus
P1.5 (Switch Row 5) ─┤6          35├─ P0.4 (AD4) ─── Address/Data Bus
P1.6 (Switch Row 6) ─┤7          34├─ P0.5 (AD5) ─── Address/Data Bus
P1.7 (Switch Row 7) ─┤8          33├─ P0.6 (AD6) ─── Address/Data Bus
        RST (Reset) ─┤9          32├─ P0.7 (AD7) ─── Address/Data Bus
  P3.0 (RXD/Keybed) ─┤10         31├─ EA (tied to GND)
  P3.1 (TXD/Keybed) ─┤11         30├─ ALE (Address Latch Enable)
        P3.2 (INT0) ─┤12         29├─ PSEN (Program Store Enable)
        P3.3 (INT1) ─┤13         28├─ P2.7 (A15) ──── High Address Bus
          P3.4 (T0) ─┤14         27├─ P2.6 (A14) ──── High Address Bus
          P3.5 (T1) ─┤15         26├─ P2.5 (A13) ──── High Address Bus
          P3.6 (WR) ─┤16         25├─ P2.4 (A12) ──── High Address Bus
          P3.7 (RD) ─┤17         24├─ P2.3 (A11) ──── High Address Bus
              XTAL2 ─┤18         23├─ P2.2 (A10) ──── High Address Bus
              XTAL1 ─┤19         22├─ P2.1 (A9) ───── High Address Bus
                GND ─┤20         21├─ P2.0 (A8) ───── High Address Bus
                     └─────────────┘
```

### Port Pin Functions

**Port 1 (P1.0-P1.7) - Switch Matrix Inputs**

```
P1.0 (Pin 1)  - Switch matrix row 0 input
P1.1 (Pin 2)  - Switch matrix row 1 input  
P1.2 (Pin 3)  - Switch matrix row 2 input
P1.3 (Pin 4)  - Switch matrix row 3 input
P1.4 (Pin 5)  - Switch matrix row 4 input
P1.5 (Pin 6)  - Switch matrix row 5 input (also release pedal input)
P1.6 (Pin 7)  - Switch matrix row 6 input
P1.7 (Pin 8)  - Switch matrix row 7 input
```

**Port 3 (P3.0-P3.7) - Special Functions**

```
P3.0 (Pin 10) - RXD: Serial receive from keybed microcontroller
P3.1 (Pin 11) - TXD: Serial transmit to keybed microcontroller / tape handshake
P3.2 (Pin 12) - INT0: External interrupt 0 (MIDI TX interrupt)
P3.3 (Pin 13) - INT1: External interrupt 1 (MIDI RX interrupt)
P3.4 (Pin 14) - T0: ADC mux select (0=pitch bend, 1=mod wheel)
P3.5 (Pin 15) - T1: MIDI UART chip select (1=enable, 0=disable)
P3.6 (Pin 16) - WR: External memory write strobe
P3.7 (Pin 17) - RD: External memory read strobe
```

**Port 0 (P0.0-P0.7) - Multiplexed Address/Data Bus**

```
P0.0-P0.7 (Pins 32-39) - Multiplexed low address (A0-A7) and data bus (D0-D7)
                        - Used for external SRAM and I/O register access
```

**Port 2 (P2.0-P2.7) - High Address Bus**

```
P2.0-P2.7 (Pins 21-28) - High address bus (A8-A15)
                        - Used for external memory addressing
```

**Control and Power Pins**

```
RST (Pin 9)    - Reset input (active high)
EA (Pin 31)    - External Access (tied to GND for external ROM)
ALE (Pin 30)   - Address Latch Enable (latches low address from P0)
PSEN (Pin 29)  - Program Store Enable (enables external ROM)
XTAL1 (Pin 19) - Crystal oscillator input
XTAL2 (Pin 18) - Crystal oscillator output
VCC (Pin 40)   - +5V power supply
GND (Pin 20)   - Ground
```

## Memory Architecture

### Memory Map Overview

* **CPU:** Intel 8031 @ 12 MHz (external ROM configuration)
* **Program ROM:** 8K EPROM (IC26), mapped at `$0000-$1FFF`

* **Lookup Tables ROM:** 8K EPROM (IC27), mapped at `$2000-$3FFF`
* **Work RAM:** 4K SRAM mapped at `$0000-$0FFF` (battery-backed patch storage)
* **I/O Block:** `$1000-$101F` decoded for hardware interface registers

### Internal RAM (8031 on-chip, 0x00-0xFF)

| Addr Range  | Purpose                                                    |
|-------------|-----------------------------------------------------------|
| `0x00-0x07` | Register bank 0 (R0-R7)                                  |
| `0x08-0x0F` | Register bank 1 (alternate R0-R7)                        |
| `0x08-0x13` | Voice note assignments (VCE1NOTE-VCE6VAR)                |
| `0x20-0x2F` | Bit-addressable area and system flags                    |
| `0x26` | LFO Flags Byte 1 (LFO1/LFO2 routing destinations)       |
| `0x27` | LFO Flags Byte 2 (LFO waveforms and invert)             |
| `0x28` | System flags (split/double mode, MIDI enables)           |
| `0x2A-0x2B` | Waveform select shadow registers                          |
| `0x30-0x31` | Current LFO1/LFO2 values                                 |
| `0x80-0xFF` | Additional variables and stack space                     |

### External SRAM Layout (0x0000-0x0FFF, battery-backed)

| Addr Range      | Purpose                                                   |
|-----------------|----------------------------------------------------------|
| `0x0000-0x002F` | Voice parameter arrays (8 bytes × 6 voices)             |
| `0x0030-0x0035` | DAC values for filter cutoff (VC1-VC6)                  |
| `0x0036-0x003B` | DAC values for VCA control (VEN1-VEN6, inverted)        |
| `0x003E` | LED mode display shadow register                         |
| `0x0067-0x006E` | 8-digit LED display buffer                               |
| `0x006F-0x0096` | Lower program parameter cache                            |
| `0x0097-0x00BE` | Upper program parameter cache                            |
| `0x0093-0x0094` | VPU1-VPU2 DAC values (DCO pulse width 1-2)             |
| `0x00BB-0x00BC` | VPU3-VPU4 DAC values (DCO pulse width 3-4)             |
| `0x00BD-0x00C6` | Envelope timing parameters                               |
| `0x00CD-0x00CE` | MIDI modulation and channel configuration                |
| `0x00CF-0x00DA` | Split point, transpose, and key data                    |
| `0x00DD-0x00EF` | Switch event circular buffer                             |
| `0x00F7-0x00FF` | Serial buffer management pointers                       |
| `0x0100-0x01FF` | MIDI RX circular buffer (256 bytes)                     |
| `0x0200-0x02FF` | Keybed RX circular buffer (256 bytes)                   |
| `0x0300-0x037F` | Tape TX buffer (128 bytes, FSK encoding)                |
| `0x0380-0x0E56` | Single programs 1-75 (37 bytes each = 2775 bytes)       |
| `0x0E57-0x0EFE` | Split/Double programs 76-99 (7 bytes each = 168 bytes)  |
| `0x0EFF-0x0F23` | Lower program working buffer (37 bytes)                 |
| `0x0F24-0x0F48` | Upper program working buffer (37 bytes)                 |
| `0x0FF0-0x0FFF` | System configuration and flags                           |

### External ROM/EPROM Lookup Tables

| Range         | Size    | Description                                    | Usage                |
|---------------|---------|------------------------------------------------|----------------------|
| `0x2000-0x20FF` | 256 B | Rising envelope/Triangle LFO table           | Envelope attack, LFO |
| `0x2100-0x21FF` | 256 B | Falling envelope/Sawtooth LFO table          | Envelope decay/release, LFO |
| `0x2200-0x22FF` | 256 B | Secondary modulation curve table             | Special modulation shapes |
| `0x2300-0x237F` | 128 B | Primary timer values (64 × 16-bit words)    | Envelope timing      |
| `0x2380-0x23FF` | 128 B | Secondary timer values (64 × 16-bit words)  | Extended timing      |
| `0x2400-0x24F3` | 244 B | MIDI note to timer divider (122 × 16-bit)   | DCO frequency generation |
| `0x2500-0x25FF` | 256 B | DCO pulse width DAC values                   | Pulse width modulation |
| `0x3000+` | var   | Timer interrupt service routine              | Real-time CV updates |

## I/O Register Map (0x1000-0x101F)

| Address     | Function                                                   |
|-------------|-----------------------------------------------------------|
| `0x1000` | MIDI UART data register (P3.5 = chip select)            |
| `0x1001` | Waveform selects 1 & 3 (lower 6 bits inverted)          |
| `0x1002` | Waveform selects 2 & 4 + switch column 3 control        |
| `0x1003` | S&H channel select + switch columns 1 & 2 control       |
| `0x1004` | Mode LEDs + tape control (shadow register 0x3E)         |
| `0x1005` | DAC output register                                      |
| `0x1006` | 7-segment display output                                 |
| `0x1007` | ADC input (P3.4 selects mod wheel vs pitch bend)        |
| `0x1010` | 8253 Timer chip IC35 (DCO frequencies)                  |
| `0x1014` | 8253 Timer chip IC36 (DCO frequencies)                  |
| `0x1018` | 8253 Timer chip IC37 (DCO frequencies)                  |
| `0x101C` | 8253 Timer chip IC38 (DCO frequencies)                  |

### Detailed Register Specifications

**0x1000 - MIDI UART Data Register**
* P3.5 = 1: Enable UART chip select
* P3.5 = 0: Disable UART chip select
* Interrupt-driven RX/TX with circular buffers

**0x1001 - Waveform Selects 1 & 3 Register**
* Controls waveform selection for DCO voices 1 and 3
* Data = shadow register 0x2A with lower 6 bits inverted
* Bits 7-6: Passed through unchanged
* Bits 5-0: Inverted from shadow register before output

**0x1002 - Waveform Selects 2 & 4 Register + Switch Column 3**
* Controls waveform selection for DCO voices 2 and 4
* Bit 7-0: All bits inverted from shadow register 0x2B
* Exception: Bit 6 controls switch column 3 drive (from shadow bit 6)
* This register combines waveform data with switch matrix control

**0x1003 - S&H Select + Switch Columns 1 & 2**
* Bits 0-5: Analog channel selection for Sample & Hold
* Bit 6: Switch column 1 drive
* Bit 7: Switch column 2 drive

**0x1004 - Mode LEDs + Tape Control**
* Bits 0-5: LED control (0 = LED on, 1 = LED off)
* Bit 6: Tape output enable (1 = enable FSK output to cassette)
* Bit 7: Switch row select for matrix scanning
* Managed via shadow register at 0x3E

**0x1005 - DAC Output**
* 8-bit DAC for selected analog channel
* Used with S&H select to update control voltages

**0x1006 - Display Register**
* 7-segment display digit output
* Multiplexed display system

**0x1007 - ADC Input**
* P3.4 = 0: Pitch bend wheel
* P3.4 = 1: Modulation wheel
* Alternated each timer interrupt cycle

### Sample & Hold Channel Codes (Register 0x1003)

| Code Range | Function                                     |
|------------|---------------------------------------------|
| `0x30-0x35` | VC1-VC6 (filter cutoff frequencies 1-6)    |
| `0x36-0x37` | VEN1-VEN2 (VCA envelope 1-2)               |
| `0x28-0x2B` | VEN3-VEN6 (VCA envelope 3-6)               |
| `0x2C-0x2F` | VPU1-VPU4 (DCO pulse width 1-4)            |
| `0x18-0x19` | LFO1/LFO2 CV outputs                        |
| `0x1A-0x1B` | VRE1/VRE2 (VCF resonance 1-3, 4-6)         |
| `0x1C` | DETUNE CV                                   |
| `0x1D` | BEND CV                                     |
| `0x1E-0x1F` | NOISE1/NOISE2 CV                            |
| `0x3F` | Disable all S&H channels                   |

## Control Voltage Generation System

The BIT 99 uses a sophisticated time-multiplexed system where a single DAC generates all control voltages:

### CV Update Sequence (every timer interrupt ~375Hz)

1. **Filter Cutoff** (VC1-VC6): 6 voices × filter frequency
2. **VCA Control** (VEN1-VEN6): 6 voices × amplitude (inverted)  
3. **Pulse Width** (VPU1-VPU4): DCO pulse width modulation
4. **LFO Outputs**: LFO1/LFO2 control voltages
5. **Filter Resonance** (VRE1-VRE2): Resonance for voices 1-3, 4-6
6. **Global CVs**: Detune, pitch bend, noise sources

### Timing Critical Operations

The CV generation follows this pattern:
1. Select S&H channel via register 0x1003
2. Write CV value to DAC via register 0x1005  
3. Disable S&H channels (set 0x1003 = 0x3F) to hold value

## Interrupt Hardware

### Interrupt Vector Table

| Vector   | Source     | Function                           |
|----------|------------|------------------------------------|
| `0x0000` | Reset      | System initialization              |
| `0x0003` | INT0       | MIDI TX ready interrupt            |
| `0x000B` | Timer 0    | CV updates, display refresh        |
| `0x0013` | INT1       | MIDI RX interrupt                  |
| `0x0023` | Serial     | Keybed serial communication       |

## Hardware Interface Subsystems

### Switch Matrix Interface

* Port 1 inputs connect to switch matrix rows
* Switch columns driven via I/O registers 0x1002 (bit 6) and 0x1003 (bits 6, 7)
* Release pedal connected to P1.5, polled during switch scanning

### MIDI Interface

* External MIDI UART connected to I/O register 0x1000
* P3.5 provides chip select signal to UART
* UART generates interrupts on P3.2 (TX ready) and P3.3 (RX ready)
* MIDI IN/OUT isolation and buffering handled by external circuitry

### Keybed Communication Hardware

**Hardware Configuration:**
* P3.0 (RXD): Serial data input from keybed microcontroller
* P3.1 (TXD): Serial data output to keybed microcontroller  
* Internal UART configured for 8-bit data, no parity
* Interrupt-driven reception via vector at 0x0023 (RI + TI)
* 256-byte circular receive buffer at 0x0200-0x02FF

**Protocol Timing:**
Two-byte sequence for each key event:
1. Note Number: Piano key - 12 (range 0x00-0x7F)
2. Velocity: 0x00 = key up, 0x01-0x1F = key down velocity

### Tape Interface Hardware

**Hardware Connections:**
* P3.1 (TXD): Dual function - keybed communication and tape handshake signal
* I/O Register 0x1004 bit 6: Tape output enable/disable control
* Tape TX buffer: 128 bytes at 0x0300-0x037F for outgoing data
* Audio output: Digital data converted to audio tones for cassette recording

**Data Format:**
* Uses frequency-shift keying (FSK) encoding for reliability
* Two audio tones represent binary 0 and 1 (typically ~1200Hz and 2400Hz)
* Includes program number, patch data, and checksum
* Can store/recall individual patches or complete program banks
* Compatible with standard audio cassette recorders

### Analog Interface

* P3.4 switches ADC input between mod wheel and pitch bend
* ADC result read from I/O register 0x1007
* Alternated each timer interrupt for continuous monitoring

### Timer Chips Interface

* Four 8253 timer chips at I/O addresses 0x1010, 0x1014, 0x1018, 0x101C
* Generate DCO frequencies based on MIDI note numbers
* Programmed with divider values from lookup table at 0x2400+

## System Timing and Performance

### Crystal Oscillator

* System appears to use 12MHz crystal (based on timer calculations in source)
* Machine cycle = 12MHz/12 = 1MHz
* Timer 0 configured for regular interrupts (display refresh and CV updates)
* Timer 0 reload value 0xA0 provides ~375Hz interrupt rate

### Real-time Operations

* Timer interrupt services display multiplexing every ~2.67ms
* All 24 control voltages updated each interrupt cycle
* Switch matrix scanned every 8th interrupt (~21.3ms)
* ADC alternates between mod wheel and pitch bend each interrupt

### DCO Frequency Generation

* 8253 timers use 2MHz clock input (derived from system clock)
* Timer divider calculation: DCO_freq = 2MHz / divider_value / 16
* MIDI note 60 (Middle C): divider ~ 956, frequency ~ 130.75Hz
* Lookup table provides equal temperament tuning across full MIDI range

### MIDI Note to Frequency Calculation

```
Timer Frequency = 2MHz / divider_value
DCO Frequency = Timer Frequency / 16
Example: MIDI note 48 (C3) = 2MHz/956/16 = 130.75 Hz
```

### Real-Time Performance Specifications

* **Timer 0 interrupt**: ~375Hz for CV updates and display refresh
* **Switch scanning**: Every 8th interrupt (~47ms) 
* **ADC sampling**: Alternates between mod wheel and pitch bend each interrupt
* **MIDI processing**: Interrupt-driven with 256-byte circular buffers
* **Voice latency**: Typically <5ms from key press to sound output
* **Interrupt latency**: <50 microseconds (estimated)
* **Key-to-sound delay**: <5 milliseconds total
* **Maximum key rate**: Limited by MIDI (31.25 kbaud) not keybed interface

### Display and User Interface Hardware

* 8-digit multiplexed LED display
* Switch matrix scanning (3 columns × 8 rows)
* Mode LEDs (Address, Compare, Lower, Upper, Split, Double, Park, Tape)
* Parameter editing with increment/decrement switches
* Front panel tape button for cassette patch storage operations
